<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure TTS Web Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-weight: 600;
        }
        
        .config-section {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }
        
        input[type="text"], input[type="password"], select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input[type="text"]:focus, input[type="password"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #edf2f7;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #e53e3e;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #38a169;
        }
        
        .audio-player {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .audio-player.active {
            display: block;
        }
        
        .audio-player h3 {
            color: #4a5568;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .audio-controls {
            margin-bottom: 15px;
        }
        
        .audio-controls audio {
            width: 100%;
            height: 60px;
        }
        
        .playback-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #edf2f7;
            border-radius: 8px;
            font-size: 14px;
            color: #4a5568;
        }
        
        .speed-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .speed-controls label {
            font-size: 14px;
            margin-bottom: 0;
            margin-right: 10px;
        }
        
        .speed-btn {
            padding: 6px 12px;
            font-size: 14px;
            min-width: 50px;
            flex: none;
        }
        
        .speed-btn.active {
            background: #667eea;
            color: white;
        }
        
        .player-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }
        
        .player-controls button {
            padding: 8px 16px;
            font-size: 14px;
            min-width: 80px;
            flex: none;
        }
        
        .status {
            margin-top: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #2f855a;
            border: 1px solid #9ae6b4;
        }
        
        .status.error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }
        
        .status.info {
            background: #bee3f8;
            color: #2b6cb0;
            border: 1px solid #90cdf4;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                flex: none;
            }
            
            .speed-controls {
                justify-content: center;
            }
            
            .player-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .player-controls button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üéµ Azure TTS Web Client</h1>
            
            <!-- Configuration Section -->
            <div class="config-section">
                <h3>Configuration</h3>
                <div class="form-group">
                    <label for="endpoint">API Endpoint:</label>
                    <input type="text" id="endpoint" 
                           value="x">
                </div>
                
                <div class="form-group">
                    <label for="apiKey">API Key:</label>
                    <input type="password" id="apiKey" 
                           value="x">
                </div>
                
                <div class="form-group">
                    <label for="voice">Voice:</label>
                    <select id="voice">
                        <option value="alloy" selected>Alloy</option>
                        <option value="echo">Echo</option>
                        <option value="fable">Fable</option>
                        <option value="onyx">Onyx</option>
                        <option value="nova">Nova</option>
                        <option value="shimmer">Shimmer</option>
                    </select>
                </div>
                
                <button class="btn-primary" onclick="initializeClient()">Initialize TTS Client</button>
            </div>
            
            <!-- Text Input Section -->
            <div class="form-group">
                <label for="textInput">Text to Convert:</label>
                <textarea id="textInput" placeholder="Enter your text here...">Welcome to the Azure Text-to-Speech web demo! This application uses Azure OpenAI's TTS API to convert your text into natural-sounding speech. 

You can paste any text here, and the application will automatically split it into chunks if it's longer than 4000 characters. The chunks are processed in parallel for faster generation, but played back sequentially to maintain the natural flow of speech.

Try pasting a long article or story to see how the chunking and parallel processing works! You can also control playback speed and pause/resume the audio using the HTML5 audio player below.</textarea>
            </div>
            
            <!-- Control Buttons -->
            <div class="button-group">
                <button class="btn-primary" id="convertBtn" onclick="convertAndPlay()" disabled>
                    üéµ Convert & Play
                </button>
                <button class="btn-secondary" onclick="clearText()">üóëÔ∏è Clear</button>
            </div>
            
            <!-- Audio Player Section -->
            <div id="audioPlayer" class="audio-player">
                <h3>üéµ Audio Player</h3>
                
                <!-- Playback Info -->
                <div class="playback-info">
                    <span id="currentChunk">Chunk: 0 / 0</span>
                    <span id="totalDuration">Duration: 00:00</span>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                
                <!-- HTML5 Audio Controls -->
                <div class="audio-controls">
                    <audio id="audioElement" controls preload="none">
                        Your browser does not support the audio element.
                    </audio>
                </div>
                
                <!-- Speed Controls -->
                <div class="speed-controls">
                    <label>Playback Speed:</label>
                    <button class="btn-secondary speed-btn" onclick="setSpeed(0.75)">0.75x</button>
                    <button class="btn-secondary speed-btn" onclick="setSpeed(0.9)">0.9x</button>
                    <button class="btn-secondary speed-btn active" onclick="setSpeed(1.0)">1.0x</button>
                    <button class="btn-secondary speed-btn" onclick="setSpeed(1.1)">1.1x</button>
                    <button class="btn-secondary speed-btn" onclick="setSpeed(1.25)">1.25x</button>
                    <button class="btn-secondary speed-btn" onclick="setSpeed(1.5)">1.5x</button>
                    <button class="btn-secondary speed-btn" onclick="setSpeed(2.0)">2.0x</button>
                </div>
                
                <!-- Player Controls -->
                <div class="player-controls">
                    <button class="btn-secondary" onclick="previousChunk()">‚èÆÔ∏è Previous</button>
                    <button class="btn-secondary" onclick="nextChunk()">‚è≠Ô∏è Next</button>
                    <button class="btn-secondary" onclick="playAllChunks()">‚ñ∂Ô∏è Play All</button>
                    <button class="btn-danger" onclick="stopPlayback()">‚èπÔ∏è Stop</button>
                </div>
            </div>
            
            <!-- Status Display -->
            <div id="status" class="status" style="display: none;"></div>
        </div>
    </div>

    <script>
        let isInitialized = false;
        let audioChunks = [];
        let currentChunkIndex = 0;
        let isPlayingSequence = false;
        let currentSpeed = 1.0;

        // Get audio element
        const audioElement = document.getElementById('audioElement');
        const audioPlayer = document.getElementById('audioPlayer');
        const progressFill = document.getElementById('progressFill');

        // Initialize TTS client
        async function initializeClient() {
            const endpoint = document.getElementById('endpoint').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!endpoint || !apiKey) {
                showStatus('Please provide both endpoint and API key', 'error');
                return;
            }
            
            showStatus('Initializing TTS client...', 'info');
            
            try {
                const response = await fetch('/api/initialize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        endpoint: endpoint,
                        api_key: apiKey
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(data.message, 'success');
                    document.getElementById('convertBtn').disabled = false;
                    isInitialized = true;
                } else {
                    showStatus(data.error, 'error');
                }
            } catch (error) {
                showStatus('Failed to initialize client: ' + error.message, 'error');
            }
        }
        
        // Convert and play audio
        async function convertAndPlay() {
            if (!isInitialized) {
                showStatus('Please initialize TTS client first', 'error');
                return;
            }
            
            const text = document.getElementById('textInput').value.trim();
            const voice = document.getElementById('voice').value;
            
            if (!text) {
                showStatus('Please enter some text', 'error');
                return;
            }
            
            showStatus('Converting text to speech...', 'info');
            document.getElementById('convertBtn').disabled = true;
            
            try {
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        voice: voice
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    audioChunks = data.audio_chunks;
                    currentChunkIndex = 0;
                    
                    showStatus(`Audio conversion completed! Generated ${data.total_chunks} chunks.`, 'success');
                    showAudioPlayer();
                    loadChunk(0);
                    
                    // Auto-play first chunk
                    setTimeout(() => {
                        audioElement.play();
                    }, 500);
                } else {
                    showStatus(data.error, 'error');
                }
            } catch (error) {
                showStatus('Failed to convert text: ' + error.message, 'error');
            } finally {
                document.getElementById('convertBtn').disabled = false;
            }
        }
        
        // Show audio player
        function showAudioPlayer() {
            audioPlayer.classList.add('active');
            updatePlaybackInfo();
        }
        
        // Hide audio player
        function hideAudioPlayer() {
            audioPlayer.classList.remove('active');
        }
        
        // Load specific chunk
        function loadChunk(index) {
            if (index < 0 || index >= audioChunks.length) return;
            
            currentChunkIndex = index;
            const chunk = audioChunks[index];
            
            // Convert base64 to blob URL
            const audioData = atob(chunk.data);
            const audioArray = new Uint8Array(audioData.length);
            for (let i = 0; i < audioData.length; i++) {
                audioArray[i] = audioData.charCodeAt(i);
            }
            const audioBlob = new Blob([audioArray], { type: 'audio/mpeg' });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            // Set audio source
            audioElement.src = audioUrl;
            audioElement.playbackRate = currentSpeed;
            audioElement.load();
            
            updatePlaybackInfo();
            updateProgress();
        }
        
        // Update playback info
        function updatePlaybackInfo() {
            document.getElementById('currentChunk').textContent = 
                `Chunk: ${currentChunkIndex + 1} / ${audioChunks.length}`;
        }
        
        // Update progress bar
        function updateProgress() {
            if (audioChunks.length === 0) return;
            
            const chunkProgress = (currentChunkIndex / audioChunks.length) * 100;
            const timeProgress = audioElement.duration > 0 ? 
                (audioElement.currentTime / audioElement.duration) * (100 / audioChunks.length) : 0;
            
            const totalProgress = chunkProgress + timeProgress;
            progressFill.style.width = totalProgress + '%';
        }
        
        // Set playback speed
        function setSpeed(speed) {
            currentSpeed = speed;
            audioElement.playbackRate = speed;
            
            // Update UI
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // Previous chunk
        function previousChunk() {
            if (currentChunkIndex > 0) {
                loadChunk(currentChunkIndex - 1);
            }
        }
        
        // Next chunk
        function nextChunk() {
            if (currentChunkIndex < audioChunks.length - 1) {
                loadChunk(currentChunkIndex + 1);
            } else {
                // End of all chunks
                isPlayingSequence = false;
                showStatus('Playback completed', 'success');
            }
        }
        
        // Play all chunks sequentially
        function playAllChunks() {
            if (audioChunks.length === 0) return;
            
            isPlayingSequence = true;
            currentChunkIndex = 0;
            loadChunk(0);
            
            setTimeout(() => {
                audioElement.play();
            }, 100);
        }
        
        // Stop playback
        function stopPlayback() {
            audioElement.pause();
            audioElement.currentTime = 0;
            isPlayingSequence = false;
            showStatus('Playback stopped', 'info');
        }
        
        // Clear text
        function clearText() {
            document.getElementById('textInput').value = '';
            hideAudioPlayer();
            audioChunks = [];
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-hide success and info messages after 5 seconds
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Audio event listeners
        audioElement.addEventListener('ended', () => {
            if (isPlayingSequence && currentChunkIndex < audioChunks.length - 1) {
                // Auto-play next chunk
                setTimeout(() => {
                    nextChunk();
                    setTimeout(() => {
                        audioElement.play();
                    }, 100);
                }, 200);
            } else {
                isPlayingSequence = false;
                showStatus('Playback completed', 'success');
            }
        });
        
        audioElement.addEventListener('timeupdate', updateProgress);
        
        audioElement.addEventListener('loadedmetadata', () => {
            const duration = Math.floor(audioElement.duration);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            document.getElementById('totalDuration').textContent = 
                `Duration: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        });
        
        audioElement.addEventListener('play', () => {
            showStatus('Playing audio...', 'info');
        });
        
        audioElement.addEventListener('pause', () => {
            if (!audioElement.ended) {
                showStatus('Audio paused', 'info');
            }
        });
    </script>
</body>
</html>
